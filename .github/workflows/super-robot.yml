name: Super IPTV Robot

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Create and run Super Robot
        run: |
          python <<'EOF'
import requests
import re
import os

channels_file = 'channels.txt'
if not os.path.exists(channels_file):
    print('âŒ Ð¤Ð°Ð¹Ð» channels.txt Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!')
    exit(1)

with open(channels_file, 'r', encoding='utf-8') as f:
    channels = [line.strip() for line in f if line.strip()]

sources = [
    'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ru.m3u',
    'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/kz.m3u',
    'https://raw.githubusercontent.com/Free-TV/IPTV/master/playlist.m3u8',
    'https://raw.githubusercontent.com/qazaqiptv/qazaqiptv.github.io/main/iptv.m3u'
]

found = {}

for url in sources:
    try:
        r = requests.get(url, timeout=15)
        r.raise_for_status()
        lines = r.text.splitlines()
        for i, line in enumerate(lines):
            line = line.strip()
            if line.startswith('#EXTINF:'):
                m = re.search(r',(.+)$', line)
                if m and i + 1 < len(lines):
                    next_line = lines[i + 1].strip()
                    if next_line and not next_line.startswith('#'):
                        name = m.group(1).strip()
                        for ch in channels:
                            if ch not in found:
                                if ch.lower() in name.lower() or name.lower() in ch.lower():
                                    found[ch] = (name, next_line)
    except requests.RequestException as e:
        print(f'âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ {url}: {e}')
        continue

with open('playlist.m3u', 'w', encoding='utf-8') as f:
    f.write('#EXTM3U x-tvg-url="http://www.teleguide.info/download/new3/jtv.zip"\n\n')
    for ch, (orig_name, stream_url) in found.items():
        f.write(f'#EXTINF:-1 group-title="ÐšÐ°Ð½Ð°Ð»Ñ‹",{orig_name}\n{stream_url}\n\n')

print(f'âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ ÐºÐ°Ð½Ð°Ð»Ð¾Ð²: {len(found)}')

not_found = [ch for ch in channels if ch not in found]
if not_found:
    print(f'âš ï¸ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ({len(not_found)}): {", ".join(not_found)}')
EOF

      - name: Commit and push
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add playlist.m3u
          git diff --staged --quiet || git commit -m 'ðŸ¤– Auto update playlist' && git push
