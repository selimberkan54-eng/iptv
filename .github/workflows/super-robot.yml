name: Super IPTV Robot

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž: Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Create Super Robot Script
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ð¿Ð°Ð¿ÐºÐ¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½ Ð²ÑÐµÐ³Ð´Ð° Ð±Ñ‹Ð» Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¼
        run: |
          cat > robot.py << 'EOF'
                - name: Create Super Robot Script
        run: |
          cat > robot.py << 'EOF'
          import requests
          import re
          import json
          from urllib.parse import urlparse
          import time

          # ... Ð¸ Ð²ÐµÑÑŒ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÐºÐ¾Ð´ Ñ‚Ð¾Ð¶Ðµ ÑÐ¾ ÑÐ¼ÐµÑ‰ÐµÐ½Ð¸ÐµÐ¼ ...
          EOF
# Ð§Ð¸Ñ‚Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð½ÑƒÐ¶Ð½Ñ‹Ñ… ÐºÐ°Ð½Ð°Ð»Ð¾Ð²
try:
    with open('channels.txt', 'r', encoding='utf-8') as f:
        MY_CHANNELS = [line.strip() for line in f if line.strip() and not line.startswith('#')]
except FileNotFoundError:
    MY_CHANNELS = ["ÐŸÐµÑ€Ð²Ñ‹Ð¹ ÐºÐ°Ð½Ð°Ð»", "Ð Ð¾ÑÑÐ¸Ñ 1", "ÐÐ¢Ð’"] # Ð—Ð°Ð³Ð»ÑƒÑˆÐºÐ°, ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð»Ð° Ð½ÐµÑ‚

print(f"ðŸŽ¯ Ð˜Ñ‰Ñƒ ÐºÐ°Ð½Ð°Ð»Ñ‹: {len(MY_CHANNELS)}")

SOURCES = [
    "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ru.m3u",
    "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/kz.m3u",
    "https://raw.githubusercontent.com/Free-TV/IPTV/master/playlist.m3u8",
    "https://raw.githubusercontent.com/otomi-corp/iptv/main/playlist.m3u",
    "https://teleguide.info/download/new3/iptv.m3u"
]

LOGOS = {
    "Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÐºÐ°Ð½Ð°Ð»": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/1tv.png",
    "Ñ€Ð¾ÑÑÐ¸Ñ 1": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/russia-1.png",
    "Ð½Ñ‚Ð²": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/ntv.png"
}

found_channels = {}

def clean_channel_name(name):
    name = re.sub(r'\s+', ' ', name)
    name = re.sub(r'[^\w\s-]', '', name)
    return name.strip().lower()

for source in SOURCES:
    try:
        print(f"ðŸ“¡ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ: {source}")
        response = requests.get(source, timeout=15)
        if response.status_code == 200:
            lines = response.text.split('\n')
            for i in range(len(lines)):
                if lines[i].startswith('#EXTINF:'):
                    match = re.search(r',([^,]+)$', lines[i])
                    if match:
                        raw_name = match.group(1).strip()
                        clean_n = clean_channel_name(raw_name)
                        for my_ch in MY_CHANNELS:
                            if clean_channel_name(my_ch) in clean_n:
                                if i + 1 < len(lines) and lines[i+1].startswith('http'):
                                    url = lines[i+1].strip()
                                    if my_ch not in found_channels:
                                        found_channels[my_ch] = {'name': my_ch, 'url': url}
                                        print(f"âœ… ÐÐ°ÑˆÑ‘Ð»: {my_ch}")
    except Exception as e:
        print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}")

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
playlist = ["#EXTM3U\n"]
for name, data in found_channels.items():
    logo = LOGOS.get(name.lower(), "")
    playlist.append(f'#EXTINF:-1 tvg-logo="{logo}",{name}\n{data["url"]}\n')

with open('playlist.m3u', 'w', encoding='utf-8') as f:
    f.write("".join(playlist))
EOF

      - name: Run Robot
        run: python robot.py

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add playlist.m3u
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð»ÐµÐ¹Ð»Ð¸ÑÑ‚Ð° $(date +'%Y-%m-%d %H:%M')" && git push)
