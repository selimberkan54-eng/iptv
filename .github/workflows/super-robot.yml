name: Super IPTV Robot

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Create and run Super Robot
        run: |
          cat > super_robot.py <<EOF
import requests
import re

with open('channels.txt', 'r', encoding='utf-8') as f:
    channels = [line.strip() for line in f if line.strip()]

sources = [
    'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ru.m3u',
    'https://raw.githubusercontent.com/iptv-org/iptv/master/streams/kz.m3u',
    'https://raw.githubusercontent.com/Free-TV/IPTV/master/playlist.m3u8',
    'https://raw.githubusercontent.com/qazaqiptv/qazaqiptv.github.io/main/iptv.m3u',
    'https://teleguide.info/download/new3/iptv.m3u'
]

found = {}

for url in sources:
    try:
        r = requests.get(url, timeout=10)
        if r.status_code != 200:
            continue
        lines = r.text.split('\n')
        i = 0
        while i < len(lines):
            if lines[i].startswith('#EXTINF:'):
                m = re.search(r',([^,]+)$', lines[i])
                if m and i+1 < len(lines) and not lines[i+1].startswith('#'):
                    name = m.group(1).strip()
                    name_clean = re.sub(r'[^\w\s-]', '', name).strip().lower()
                    for ch in channels:
                        ch_clean = re.sub(r'[^\w\s-]', '', ch).strip().lower()
                        if ch_clean in name_clean or name_clean in ch_clean:
                            if ch not in found:
                                found[ch] = lines[i+1].strip()
            i += 1
    except:
        continue

with open('playlist.m3u', 'w', encoding='utf-8') as f:
    f.write('#EXTM3U x-tvg-url="http://www.teleguide.info/download/new3/jtv.zip"\n\n')
    for name, url in found.items():
        f.write(f'#EXTINF:-1 group-title="ÐšÐ°Ð½Ð°Ð»Ñ‹",{name}\n')
        if 'georgia_play' in url:
            f.write('#EXTVLCOPT:http-user-agent=VLC/3.0.18\n')
            f.write('#EXTVLCOPT:http-referrer=http://158.101.222.193:88/\n')
        f.write(f'{url}\n\n')

print(f'âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ ÐºÐ°Ð½Ð°Ð»Ð¾Ð²: {len(found)}')
EOF
          python super_robot.py

      - name: Commit and push
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add playlist.m3u
          git diff --quiet && git diff --staged --quiet || (git commit -m 'ðŸ¤– Auto update' && git push)
