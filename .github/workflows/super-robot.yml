name: Super IPTV Robot

on:
  schedule:
    # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 6 Ñ‡Ð°ÑÐ¾Ð²
    - cron: '0 */6 * * *'
  workflow_dispatch:  # ÐœÐ¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install requests
          pip install m3u8

      - name: Create Super Robot
        run: |
          cat > super_robot.py << 'EOF'
import requests
import re
import json
from urllib.parse import urlparse
import time

# ============== Ð¢Ð’ÐžÐ™ Ð¡ÐŸÐ˜Ð¡ÐžÐš ÐšÐÐÐÐ›ÐžÐ’ ==============
with open('channels.txt', 'r', encoding='utf-8') as f:
    MY_CHANNELS = [line.strip() for line in f if line.strip() and not line.startswith('#')]

print(f"ðŸŽ¯ Ð˜Ñ‰Ñƒ ÐºÐ°Ð½Ð°Ð»Ñ‹: {len(MY_CHANNELS)}")

# ============== Ð˜Ð¡Ð¢ÐžÐ§ÐÐ˜ÐšÐ˜ Ð”Ð›Ð¯ ÐŸÐžÐ˜Ð¡ÐšÐ ==============
SOURCES = [
    # GitHub Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸
    "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/ru.m3u",
    "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/kz.m3u",
    "https://raw.githubusercontent.com/Free-TV/IPTV/master/playlist.m3u8",
    "https://raw.githubusercontent.com/Free-TV/IPTV/master/playlist.m3u",
    "https://raw.githubusercontent.com/otomi-corp/iptv/main/playlist.m3u",
    "https://raw.githubusercontent.com/ForceFM/iptv/main/playlist.m3u",
    "https://raw.githubusercontent.com/EvgenyChernyshev/iptv/master/iptv.m3u",
    
    # ÐšÐ°Ð·Ð°Ñ…ÑÑ‚Ð°Ð½ÑÐºÐ¸Ðµ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸
    "https://raw.githubusercontent.com/qazaqiptv/qazaqiptv.github.io/main/iptv.m3u",
    "https://raw.githubusercontent.com/aitym/iptv/main/kz.m3u",
    
    # Ð¡Ð¿ÑƒÑ‚Ð½Ð¸ÐºÐ¾Ð²Ñ‹Ðµ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸
    "https://raw.githubusercontent.com/andrey-tsarsky/edem-iptv/master/edem_all_channels.m3u",
    
    # ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿Ð»ÐµÐ¹Ð»Ð¸ÑÑ‚Ñ‹
    "https://teleguide.info/download/new3/iptv.m3u",
]

# ============== Ð›ÐžÐ“ÐžÐ¢Ð˜ÐŸÐ« ==============
LOGOS = {
    "national geographic": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/national-geographic.png",
    "nat geo wild": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/nat-geo-wild.png",
    "discovery": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/discovery-channel.png",
    "animal planet": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/animal-planet.png",
    "viasat nature": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/viasat-nature.png",
    "viasat explore": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/viasat-explore.png",
    "viasat history": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/viasat-history.png",
    "Ð¼Ð¾Ñ Ð¿Ð»Ð°Ð½ÐµÑ‚Ð°": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/moya-planeta.png",
    "Ð¶Ð¸Ð²Ð°Ñ Ð¿Ð»Ð°Ð½ÐµÑ‚Ð°": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/zhivaya-planeta.png",
    "Ð½Ð°ÑƒÐºÐ° 2.0": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/nauka-20.png",
    "terra": "https://i.imgur.com/Jk9M3jL.png",
    "Ð·Ð¾Ð¾Ð¿Ð°Ñ€Ðº": "https://i.imgur.com/Z7xL9qW.png",
    "Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÐºÐ°Ð½Ð°Ð»": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/1tv.png",
    "Ñ€Ð¾ÑÑÐ¸Ñ 1": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/russia-1.png",
    "Ñ€Ð¾ÑÑÐ¸Ñ 24": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/russia-24.png",
    "Ð½Ñ‚Ð²": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/ntv.png",
    "Ñ€Ð±Ðº": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/rbc.png",
    "Ð¼Ð¸Ñ€": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/mir.png",
    "Ð¼Ð¸Ñ€ 24": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/mir-24.png",
    "kinohit": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/kinohit.png",
    "ÐºÐ¸Ð½Ð¾ÐºÐ¾Ð¼ÐµÐ´Ð¸Ñ": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/kinokomediya.png",
    "ÐºÐ¸Ð½Ð¾Ð¼Ð¸ÐºÑ": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/kinomiks.png",
    "tv1000": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/tv1000.png",
    "viju tv1000 Ñ€ÑƒÑÑÐºÐ¾Ðµ": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/tv1000-russkoe-kino.png",
    "viju tv1000 action": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/tv1000-action.png",
    "Ð¸Ð»Ð»ÑŽÐ·Ð¸Ð¾Ð½+": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/illuzion-plus.png",
    "ÐµÐ²Ñ€Ð¾ÐºÐ¸Ð½Ð¾": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/eurokino.png",
    "amedia 1": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/amedia-1.png",
    "amedia 2": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/amedia-2.png",
    "amedia hit": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/amedia-hit.png",
    "amedia premium": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/amedia-premium.png",
    "paramount channel": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/paramount-channel.png",
    "mgm channel": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/mgm-channel.png",
    "Ð¼Ð°Ñ‚Ñ‡ Ñ‚Ð²": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/match-tv.png",
    "Ð¼Ð°Ñ‚Ñ‡ Ð°Ñ€ÐµÐ½Ð°": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/match-arena.png",
    "Ð¼Ð°Ñ‚Ñ‡ Ð¸Ð³Ñ€Ð°": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/match-igra.png",
    "Ð¼Ð°Ñ‚Ñ‡ Ñ„ÑƒÑ‚Ð±Ð¾Ð» 1": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/match-football-1.png",
    "Ð¼Ð°Ñ‚Ñ‡ Ñ„ÑƒÑ‚Ð±Ð¾Ð» 2": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/match-football-2.png",
    "Ð¼Ð°Ñ‚Ñ‡ Ñ„ÑƒÑ‚Ð±Ð¾Ð» 3": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/match-football-3.png",
    "eurosport 1": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/eurosport-1.png",
    "eurosport 2": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/eurosport-2.png",
    "Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/istoriya.png",
    "365 Ð´Ð½ÐµÐ¹ Ñ‚Ð²": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/365-dney.png",
    "da vinci learning": "https://cdn.jsdelivr.net/gh/iptv-org/logo/ru/tv/da-vinci-learning.png",
    "Ð¾Ñ…Ð¾Ñ‚Ð° Ð¸ Ñ€Ñ‹Ð±Ð°Ð»ÐºÐ°": "https://i.imgur.com/hC88Xz.png",
    "Ð´Ð¸ÐºÐ¸Ð¹": "https://i.imgur.com/hK7f9f7.png",
}

# ============== ÐŸÐžÐ˜Ð¡Ðš ÐŸÐž Ð˜Ð¡Ð¢ÐžÐ§ÐÐ˜ÐšÐÐœ ==============
found_channels = {}

def clean_channel_name(name):
    """ÐžÑ‡Ð¸Ñ‰Ð°ÐµÑ‚ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ°Ð½Ð°Ð»Ð° Ð¾Ñ‚ Ð¼ÑƒÑÐ¾Ñ€Ð°"""
    name = re.sub(r'\s+', ' ', name)
    name = re.sub(r'[^\w\s-]', '', name)
    return name.strip().lower()

def check_quality(url):
    """ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð²Ð¸Ð´ÐµÐ¾ (Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ ÑÐ²Ñ€Ð¸ÑÑ‚Ð¸ÐºÐ°)"""
    if '1080' in url or 'fullhd' in url.lower() or 'fhd' in url.lower():
        return '1080p'
    elif '720' in url:
        return '720p'
    elif '480' in url:
        return '480p'
    else:
        return 'unknown'

print("ðŸ” ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð¿Ð¾Ð¸ÑÐº...")

for source in SOURCES:
    try:
        print(f"ðŸ“¡ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ: {source}")
        response = requests.get(source, timeout=10)
        if response.status_code == 200:
            content = response.text
            
            # ÐŸÐ°Ñ€ÑÐ¸Ð¼ M3U
            lines = content.split('\n')
            i = 0
            while i < len(lines):
                line = lines[i]
                if line.startswith('#EXTINF:'):
                    # Ð˜Ñ‰ÐµÐ¼ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ°Ð½Ð°Ð»Ð°
                    channel_info = line
                    channel_name_match = re.search(r',([^,]+)$', line)
                    if channel_name_match:
                        channel_name = channel_name_match.group(1).strip()
                        clean_name = clean_channel_name(channel_name)
                        
                        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‚Ð°ÐºÐ¾Ð¹ ÐºÐ°Ð½Ð°Ð» Ð² Ð½Ð°ÑˆÐµÐ¼ ÑÐ¿Ð¸ÑÐºÐµ
                        for my_channel in MY_CHANNELS:
                            my_clean = clean_channel_name(my_channel)
                            if my_clean in clean_name or clean_name in my_clean:
                                # ÐÐ°ÑˆÐ»Ð¸! Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸Ð¼ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ (ÑÑÑ‹Ð»ÐºÑƒ)
                                if i + 1 < len(lines) and not lines[i+1].startswith('#'):
                                    url = lines[i+1].strip()
                                    
                                    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾
                                    quality = check_quality(url)
                                    
                                    # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼
                                    if my_channel not in found_channels:
                                        found_channels[my_channel] = {
                                            'name': my_channel,
                                            'url': url,
                                            'quality': quality,
                                            'source': source
                                        }
                                        print(f"âœ… ÐÐ°ÑˆÑ‘Ð»: {my_channel} [{quality}]")
                i += 1
    except Exception as e:
        print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ {source}: {e}")

# ============== Ð¡ÐžÐ—Ð”ÐÐÐœ Ð“ÐžÐ¢ÐžÐ’Ð«Ð™ ÐŸÐ›Ð•Ð™Ð›Ð˜Ð¡Ð¢ ==============
print(f"\nðŸŽ¯ Ð’ÑÐµÐ³Ð¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾: {len(found_channels)} ÐºÐ°Ð½Ð°Ð»Ð¾Ð²")

playlist_lines = []
playlist_lines.append('#EXTM3U x-tvg-url="http://www.teleguide.info/download/new3/jtv.zip" refresh="24"\n')

# Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ð½Ð°Ð»Ñ‹
groups = {
    'ÐŸÑ€Ð¸Ñ€Ð¾Ð´Ð° (Ð¼Ð¸Ñ€)': ['national geographic', 'nat geo wild', 'discovery', 'animal planet', 'viasat nature', 'viasat explore'],
    'ÐŸÑ€Ð¸Ñ€Ð¾Ð´Ð° (Ð Ð¾ÑÑÐ¸Ñ)': ['Ð¼Ð¾Ñ Ð¿Ð»Ð°Ð½ÐµÑ‚Ð°', 'Ð¶Ð¸Ð²Ð°Ñ Ð¿Ð»Ð°Ð½ÐµÑ‚Ð°', 'Ð½Ð°ÑƒÐºÐ° 2.0', 'terra', 'Ð·Ð¾Ð¾Ð¿Ð°Ñ€Ðº'],
    'ÐÐ¾Ð²Ð¾ÑÑ‚Ð¸': ['Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÐºÐ°Ð½Ð°Ð»', 'Ñ€Ð¾ÑÑÐ¸Ñ 1', 'Ñ€Ð¾ÑÑÐ¸Ñ 24', 'Ð½Ñ‚Ð²', 'Ñ€Ð±Ðº', 'Ð¼Ð¸Ñ€', 'Ð¼Ð¸Ñ€ 24'],
    'ÐšÐ¸Ð½Ð¾': ['kinohit', 'ÐºÐ¸Ð½Ð¾ÐºÐ¾Ð¼ÐµÐ´Ð¸Ñ', 'ÐºÐ¸Ð½Ð¾Ð¼Ð¸ÐºÑ', 'tv1000', 'viju tv1000 Ñ€ÑƒÑÑÐºÐ¾Ðµ', 'viju tv1000 action', 'Ð¸Ð»Ð»ÑŽÐ·Ð¸Ð¾Ð½+', 'ÐµÐ²Ñ€Ð¾ÐºÐ¸Ð½Ð¾', 'amedia', 'paramount', 'mgm'],
    'Ð¡Ð¿Ð¾Ñ€Ñ‚': ['Ð¼Ð°Ñ‚Ñ‡ Ñ‚Ð²', 'Ð¼Ð°Ñ‚Ñ‡ Ð°Ñ€ÐµÐ½Ð°', 'Ð¼Ð°Ñ‚Ñ‡ Ð¸Ð³Ñ€Ð°', 'Ð¼Ð°Ñ‚Ñ‡ Ñ„ÑƒÑ‚Ð±Ð¾Ð»', 'eurosport'],
    'ÐŸÐ¾Ð·Ð½Ð°Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ': ['Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ', 'viasat history', '365 Ð´Ð½ÐµÐ¹ Ñ‚Ð²', 'da vinci learning', 'Ð¾Ñ…Ð¾Ñ‚Ð° Ð¸ Ñ€Ñ‹Ð±Ð°Ð»ÐºÐ°', 'Ð´Ð¸ÐºÐ¸Ð¹']
}

# Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ð¼
added = set()
for group_name, keywords in groups.items():
    group_channels = []
    for ch_name, ch_data in found_channels.items():
        ch_lower = ch_name.lower()
        for keyword in keywords:
            if keyword in ch_lower and ch_name not in added:
                group_channels.append(ch_data)
                added.add(ch_name)
                break
    
    if group_channels:
        playlist_lines.append(f'\n# ============== {group_name} ==============\n')
        for ch in group_channels:
            logo_url = LOGOS.get(ch['name'].lower(), 'https://i.imgur.com/default.png')
            tvg_id = ch['name'].lower().replace(' ', '_')
            
            extinf = f'#EXTINF:-1 tvg-id="{tvg_id}" tvg-logo="{logo_url}" group-title="{group_name}",{ch["name"]}'
            playlist_lines.append(extinf)
            
            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ User-Agent ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
            if 'georgia_play' in ch['url']:
                playlist_lines.append('#EXTVLCOPT:http-user-agent=VLC/3.0.18')
                playlist_lines.append('#EXTVLCOPT:http-referrer=http://158.101.222.193:88/')
            
            playlist_lines.append(ch['url'])
            playlist_lines.append('')

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾ÑÑ‚Ð°Ð²ÑˆÐ¸ÐµÑÑ ÐºÐ°Ð½Ð°Ð»Ñ‹ (Ð±ÐµÐ· Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹)
others = [ch for ch_name, ch in found_channels.items() if ch_name not in added]
if others:
    playlist_lines.append('\n# ============== Ð”Ñ€ÑƒÐ³Ð¸Ðµ ÐºÐ°Ð½Ð°Ð»Ñ‹ ==============\n')
    for ch in others:
        logo_url = LOGOS.get(ch['name'].lower(), 'https://i.imgur.com/default.png')
        tvg_id = ch['name'].lower().replace(' ', '_')
        
        extinf = f'#EXTINF:-1 tvg-id="{tvg_id}" tvg-logo="{logo_url}" group-title="Ð”Ñ€ÑƒÐ³Ð¸Ðµ",{ch["name"]}'
        playlist_lines.append(extinf)
        
        if 'georgia_play' in ch['url']:
            playlist_lines.append('#EXTVLCOPT:http-user-agent=VLC/3.0.18')
            playlist_lines.append('#EXTVLCOPT:http-referrer=http://158.101.222.193:88/')
        
        playlist_lines.append(ch['url'])
        playlist_lines.append('')

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼
with open('playlist.m3u', 'w', encoding='utf-8') as f:
    f.write('\n'.join(playlist_lines))

print(f"\nâœ… ÐŸÐ»ÐµÐ¹Ð»Ð¸ÑÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½! ÐšÐ°Ð½Ð°Ð»Ð¾Ð²: {len(found_channels)}")
print(f"ðŸ“ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð² playlist.m3u")

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
from collections import Counter
quals = [ch['quality'] for ch in found_channels.values()]
qual_stats = Counter(quals)
print(f"\nðŸ“Š ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾:")
for q, count in qual_stats.items():
    print(f"  {q}: {count}")
EOF

      - name: Run Super Robot
        run: python super_robot.py

      - name: Commit and push
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add playlist.m3u
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Super Robot: Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð»ÐµÐ¹Ð»Ð¸ÑÑ‚Ð° $(date +'%Y-%m-%d %H:%M')" && git push)
